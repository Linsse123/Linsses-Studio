<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architect AI - Scanner Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #0f172a; --sidebar: #1e293b; --primary: #6366f1; 
            --accent: #818cf8; --success: #10b981; --text: #f1f5f9;
        }
        
        body { 
            font-family: 'Inter', sans-serif; background: var(--bg); 
            color: var(--text); margin: 0; display: flex; height: 100vh; 
        }

        /* Sidebar Elegante */
        .sidebar { 
            width: 320px; background: var(--sidebar); padding: 25px; 
            display: flex; flex-direction: column; gap: 20px; 
            box-shadow: 4px 0 15px rgba(0,0,0,0.3); z-index: 10;
        }

        h2 { font-weight: 600; margin: 0; display: flex; align-items: center; gap: 10px; }
        
        .upload-area {
            border: 2px dashed #475569; border-radius: 12px; padding: 20px;
            text-align: center; cursor: pointer; transition: all 0.3s;
        }
        .upload-area:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }

        .control-group { background: #334155; padding: 15px; border-radius: 10px; }
        
        input[type="range"] { width: 100%; accent-color: var(--primary); }

        .btn-main { 
            background: var(--primary); color: white; border: none; 
            padding: 14px; border-radius: 10px; font-weight: 600; 
            cursor: pointer; transition: 0.2s;
        }
        .btn-main:hover { background: var(--accent); transform: translateY(-2px); }
        .btn-main:disabled { background: #475569; cursor: not-allowed; transform: none; }

        /* √Årea de Trabajo Principal */
        .main { flex: 1; position: relative; overflow: auto; display: flex; justify-content: center; align-items: flex-start; padding: 40px; }
        
        canvas { 
            background: white; border-radius: 4px; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); 
            max-width: 100%; cursor: crosshair;
        }

        /* Card de Resultados */
        .result-card { 
            background: var(--success); color: white; padding: 20px; 
            border-radius: 12px; text-align: center; animation: slideIn 0.3s ease-out;
        }
        #doorCount { font-size: 42px; font-weight: 700; display: block; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #loading { 
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); 
            display: none; flex-direction: column; align-items: center; 
            justify-content: center; z-index: 1000; 
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div id="loadingText">Procesando Planos...</div>
    </div>
    
    <div class="sidebar">
        <h2>‚ó™ Architect AI</h2>
        
        <div class="upload-area" onclick="document.getElementById('pdfInput').click()" id="dropZone">
            <span style="font-size: 24px;">üìÑ</span>
            <p style="margin: 10px 0 0; font-size: 14px;">Haz clic o arrastra tu PDF aqu√≠</p>
        </div>
        <input type="file" id="pdfInput" accept="application/pdf" style="display:none">
        
        <div class="control-group">
            <label style="font-size: 12px; color: #94a3b8;">SENSIBILIDAD DE IA</label>
            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                <span id="confVal" style="font-weight: 600;">50%</span>
            </div>
            <input type="range" min="10" max="95" value="50" id="confSlider" oninput="document.getElementById('confVal').innerText=this.value+'%'">
        </div>

        <button id="btnAnalyze" class="btn-main" onclick="runAnalysis()" disabled>ESCANEAR SELECCI√ìN</button>
        
        <div id="resultCard" class="result-card" style="display:none;">
            <span style="font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Puertas Encontradas</span>
            <span id="doorCount">0</span>
        </div>

        <div id="debugBox" style="display:none; margin-top: auto;">
            <p style="font-size: 11px; color: #94a3b8; margin-bottom: 5px;">VISTA PREVIA DEL ESCANEO:</p>
            <img id="debugImg" style="width:100%; border-radius: 8px; border: 1px solid #475569;">
        </div>
    </div>

    <div class="main" id="mainArea">
        <canvas id="mainCanvas"></canvas>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        let isDrawing = false, sX, sY, bgImage = null, currentZone = null;
        const canvas = document.getElementById('mainCanvas'), ctx = canvas.getContext('2d');

        // L√≥gica de Drag and Drop
        const dropZone = document.getElementById('dropZone');
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = "#6366f1"; };
        dropZone.ondragleave = () => { dropZone.style.borderColor = "#475569"; };
        dropZone.ondrop = (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file.type === "application/pdf") processPDF(file);
        };

        document.getElementById('pdfInput').onchange = (e) => processPDF(e.target.files[0]);

        async function processPDF(file) {
            if (!file) return;
            document.getElementById('loading').style.display = 'flex';
            
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const page = await pdf.getPage(1);
            const viewport = page.getViewport({ scale: 2.0 });
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = viewport.width; tempCanvas.height = viewport.height;
            await page.render({ canvasContext: tempCanvas.getContext('2d'), viewport: viewport }).promise;
            
            bgImage = new Image();
            bgImage.src = tempCanvas.toDataURL('image/jpeg', 0.90);
            bgImage.onload = () => {
                canvas.width = viewport.width; canvas.height = viewport.height;
                redraw();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('btnAnalyze').disabled = false;
                dropZone.innerHTML = `<span style="color:#10b981">‚úì Archivo Cargado</span><br><small>${file.name}</small>`;
            };
        }

        function redraw() { if (bgImage) ctx.drawImage(bgImage, 0, 0); }

        canvas.onmousedown = e => { 
            const rect = canvas.getBoundingClientRect();
            sX = (e.clientX - rect.left) * (canvas.width / rect.width);
            sY = (e.clientY - rect.top) * (canvas.height / rect.height);
            isDrawing = true; 
        };

        canvas.onmousemove = e => {
            if(!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const currX = (e.clientX - rect.left) * (canvas.width / rect.width);
            const currY = (e.clientY - rect.top) * (canvas.height / rect.height);
            ctx.clearRect(0,0,canvas.width,canvas.height);
            redraw();
            ctx.strokeStyle = '#6366f1'; ctx.lineWidth = 3; ctx.setLineDash([5, 5]);
            ctx.strokeRect(sX, sY, currX - sX, currY - sY);
        };

        canvas.onmouseup = e => {
            if(!isDrawing) return;
            isDrawing = false;
            const rect = canvas.getBoundingClientRect();
            const eX = (e.clientX - rect.left) * (canvas.width / rect.width);
            const eY = (e.clientY - rect.top) * (canvas.height / rect.height);
            currentZone = { x: Math.min(sX, eX), y: Math.min(sY, eY), w: Math.abs(eX - sX), h: Math.abs(eY - sY) };
            ctx.setLineDash([]);
        };

        async function runAnalysis() {
    if (!currentZone || !bgImage) return;
    document.getElementById('loading').style.display = 'flex';

    // --- OPTIMIZACI√ìN DE VELOCIDAD: RECORTE LOCAL ---
    const offscreenCanvas = document.createElement('canvas');
    const offCtx = offscreenCanvas.getContext('2d');
    
    // El tama√±o del canvas de recorte es el tama√±o de la selecci√≥n
    offscreenCanvas.width = currentZone.w;
    offscreenCanvas.height = currentZone.h;
    
    // Dibujamos solo el pedazo seleccionado del plano original
    offCtx.drawImage(
        canvas, 
        currentZone.x, currentZone.y, currentZone.w, currentZone.h, // Fuente
        0, 0, currentZone.w, currentZone.h // Destino
    );

    // Convertimos a Base64 con calidad reducida (0.7) para mayor rapidez
    const croppedBase64 = offscreenCanvas.toDataURL('image/jpeg', 0.7).split(',')[1];

    const res = await fetch('/analyze_zone_fast', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            image_b64: croppedBase64,
            min_confidence: document.getElementById('confSlider').value
        })
    });
    
    const data = await res.json();
    
    // Limpiar y redibujar
    ctx.clearRect(0,0,canvas.width,canvas.height);
    redraw(); 
    
    document.getElementById('resultCard').style.display = 'block';
    document.getElementById('doorCount').innerText = data.count || 0;

    if (data.detections) {
        data.detections.forEach(d => {
            ctx.strokeStyle = '#22c55e'; ctx.lineWidth = 5;
            // IMPORTANTE: d.x y d.y ya vienen relativos al recorte
            ctx.strokeRect(currentZone.x + d.x, currentZone.y + d.y, d.width, d.height);
        });
    }
    
    // Actualizamos el "Zoom de IA" con el recorte que hicimos localmente
    document.getElementById('debugBox').style.display = 'block';
    document.getElementById('debugImg').src = 'data:image/jpeg;base64,' + croppedBase64;
    
    document.getElementById('loading').style.display = 'none';
}
    </script>
</body>
</html>